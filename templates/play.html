<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MATHLY // SECTORS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #08080a;
            --bg-panel: rgba(12, 12, 14, 0.95);
            --bg-elevated: rgba(20, 20, 22, 0.9);
            --text: #d1dce5;
            --text-dim: #6b7280;
            --text-muted: #4a4f57;
            --accent: #1a3d34;
            --accent-light: #2a5d4a;
            --border: #1c1c1e;
            --border-light: #2a2a2e;
            --success: #2d5a47;
            --error: #5a2d2d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', -apple-system, sans-serif;
            min-height: 100vh;
            line-height: 1.5;
        }

        .bg-grid {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image:
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
        }

        .geo-ring {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 800px; height: 800px;
            border: 1px solid rgba(26, 61, 52, 0.15);
            border-radius: 50%;
            pointer-events: none;
            animation: slowRotate 200s linear infinite;
        }
        .geo-ring:nth-child(2) { width: 600px; height: 600px; animation-duration: 180s; animation-direction: reverse; }
        .geo-ring:nth-child(3) { width: 1000px; height: 1000px; animation-duration: 240s; border-style: dashed; }

        @keyframes slowRotate {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .corner-data {
            position: fixed;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            color: var(--text-muted);
            pointer-events: none;
            z-index: 100;
            line-height: 1.6;
        }
        .corner-data.tl { top: 15px; left: 15px; }
        .corner-data.tr { top: 15px; right: 15px; text-align: right; }
        .corner-data.bl { bottom: 15px; left: 15px; }
        .corner-data.br { bottom: 15px; right: 15px; text-align: right; }
        .corner-data span { color: var(--accent-light); }

        .header {
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 50;
        }

        .logo-group {
            display: flex;
            align-items: baseline;
            gap: 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: 600;
            letter-spacing: 2px;
            color: var(--text);
        }

        .logo-tag {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            color: var(--text-muted);
            letter-spacing: 1px;
        }

        .header-stats {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .stat {
            text-align: right;
        }
        .stat-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 2px;
        }
        .stat-value {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 20px;
            font-weight: 500;
            color: var(--text);
        }

        .nav-links {
            display: flex;
            gap: 8px;
        }
        .nav-link {
            font-size: 12px;
            color: var(--text-dim);
            text-decoration: none;
            padding: 8px 16px;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }
        .nav-link:hover {
            color: var(--text);
            border-color: var(--accent);
            background: rgba(26, 61, 52, 0.1);
        }

        .main {
            padding: 40px 30px;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .page-title {
            font-size: 28px;
            font-weight: 300;
            letter-spacing: 1px;
        }
        .page-title strong {
            font-weight: 600;
            color: var(--accent-light);
        }

        .page-meta {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            color: var(--text-muted);
            text-align: right;
        }

        .sectors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .sector-card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            padding: 25px;
            position: relative;
            transition: all 0.2s;
            --tier-color: #2a5d4a;
            --effect-color-1: #ff4500;
            --effect-color-2: #ff6347;
            --effect-color-3: #ff8c00;
            --effect-color-4: #ffd700;
        }
        .sector-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 4px; height: 100%;
            background: var(--tier-color);
            transition: background 0.3s;
        }

        .sector-card:hover {
            border-color: var(--tier-color);
        }

        .sector-card[data-effect]::after {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            pointer-events: none;
            z-index: -1;
        }

        /* FLAMES - Level 20+ */
        .sector-card[data-effect="flames"]::after {
            background: linear-gradient(0deg,
                var(--effect-color-1),
                var(--effect-color-2),
                var(--effect-color-3),
                var(--effect-color-4),
                transparent 90%);
            background-size: 100% 200%;
            animation: flamesRise 0.8s ease-in-out infinite;
            filter: blur(6px);
            opacity: 0.75;
        }
        .sector-card[data-effect="flames"] {
            box-shadow: 0 0 20px var(--effect-color-1),
                        0 0 40px var(--effect-color-2),
                        inset 0 -5px 15px rgba(255, 100, 0, 0.1);
        }

        /* LIGHTNING - Level 40+ */
        .sector-card[data-effect="lightning"]::after {
            background: linear-gradient(135deg,
                var(--effect-color-1),
                var(--effect-color-2),
                #ffffff,
                var(--effect-color-3),
                var(--effect-color-4));
            background-size: 400% 400%;
            animation: lightningCrackle 0.15s steps(3) infinite, lightningPulse 2s ease-in-out infinite;
            filter: blur(4px);
            opacity: 0.7;
        }
        .sector-card[data-effect="lightning"] {
            box-shadow: 0 0 15px var(--effect-color-1),
                        0 0 30px var(--effect-color-2);
        }
        .sector-card[data-effect="lightning"]::before {
            animation: lightningFlicker 0.1s steps(2) infinite;
        }

        /* GLASSY - Level 60+ */
        .sector-card[data-effect="glassy"] {
            background: linear-gradient(135deg,
                rgba(var(--glass-r), var(--glass-g), var(--glass-b), 0.15),
                rgba(var(--glass-r), var(--glass-g), var(--glass-b), 0.05),
                rgba(255, 255, 255, 0.1),
                rgba(var(--glass-r), var(--glass-g), var(--glass-b), 0.08));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(var(--glass-r), var(--glass-g), var(--glass-b), 0.3);
        }
        .sector-card[data-effect="glassy"]::after {
            background: linear-gradient(135deg,
                rgba(255,255,255,0.5) 0%,
                rgba(var(--glass-r), var(--glass-g), var(--glass-b), 0.3) 25%,
                transparent 50%,
                rgba(var(--glass-r), var(--glass-g), var(--glass-b), 0.2) 75%,
                rgba(255,255,255,0.4) 100%);
            background-size: 200% 200%;
            animation: glassyShine 4s ease-in-out infinite;
            filter: blur(2px);
            opacity: 0.6;
        }
        .sector-card[data-effect="glassy"]::before {
            background: linear-gradient(180deg,
                rgba(255,255,255,0.8),
                var(--tier-color),
                rgba(255,255,255,0.4));
        }

        /* GOLD SPARKLES - Level 80+ */
        .sector-card[data-effect="gold-sparkles"]::after {
            background:
                radial-gradient(circle at 20% 30%, var(--effect-color-1) 1px, transparent 2px),
                radial-gradient(circle at 80% 20%, var(--effect-color-2) 1px, transparent 2px),
                radial-gradient(circle at 40% 70%, var(--effect-color-3) 1px, transparent 2px),
                radial-gradient(circle at 70% 60%, var(--effect-color-4) 1px, transparent 2px),
                radial-gradient(circle at 10% 80%, var(--effect-color-1) 1px, transparent 2px),
                radial-gradient(circle at 90% 90%, var(--effect-color-2) 1px, transparent 2px),
                radial-gradient(circle at 50% 10%, var(--effect-color-3) 1px, transparent 2px),
                radial-gradient(circle at 30% 50%, var(--effect-color-4) 1px, transparent 2px),
                linear-gradient(45deg,
                    var(--effect-color-1),
                    var(--effect-color-2),
                    var(--effect-color-3),
                    var(--effect-color-4));
            background-size: 100% 100%, 100% 100%, 100% 100%, 100% 100%,
                           100% 100%, 100% 100%, 100% 100%, 100% 100%, 300% 300%;
            animation: goldSparkle 1.5s ease-in-out infinite, goldShimmerBg 3s linear infinite;
            filter: blur(3px);
            opacity: 0.8;
        }
        .sector-card[data-effect="gold-sparkles"] {
            box-shadow: 0 0 25px var(--effect-color-1),
                        0 0 50px var(--effect-color-2),
                        inset 0 0 20px rgba(255, 215, 0, 0.1);
        }
        .sector-card[data-effect="gold-sparkles"]::before {
            background: linear-gradient(180deg,
                var(--effect-color-4),
                var(--effect-color-1),
                var(--effect-color-3));
            animation: goldBarPulse 2s ease-in-out infinite;
        }

        @keyframes flamesRise {
            0%, 100% {
                background-position: 0% 100%;
                opacity: 0.6;
            }
            25% { background-position: 0% 80%; }
            50% {
                background-position: 0% 50%;
                opacity: 0.85;
            }
            75% { background-position: 0% 70%; }
        }

        @keyframes lightningCrackle {
            0% { background-position: 0% 0%; }
            33% { background-position: 100% 100%; }
            66% { background-position: 50% 25%; }
            100% { background-position: 0% 0%; }
        }

        @keyframes lightningPulse {
            0%, 100% { opacity: 0.5; }
            10% { opacity: 0.9; }
            15% { opacity: 0.3; }
            20% { opacity: 1; }
            25% { opacity: 0.4; }
            50% { opacity: 0.6; }
            80% { opacity: 0.5; }
            85% { opacity: 0.95; }
            90% { opacity: 0.4; }
        }

        @keyframes lightningFlicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes glassyShine {
            0%, 100% { background-position: 0% 0%; }
            50% { background-position: 100% 100%; }
        }

        @keyframes goldSparkle {
            0%, 100% {
                opacity: 0.7;
                filter: blur(3px) brightness(1);
            }
            25% { filter: blur(2px) brightness(1.3); }
            50% {
                opacity: 0.9;
                filter: blur(4px) brightness(1.5);
            }
            75% { filter: blur(2px) brightness(1.2); }
        }

        @keyframes goldShimmerBg {
            0% { background-position: 0% 0%, 0% 0%, 0% 0%, 0% 0%, 0% 0%, 0% 0%, 0% 0%, 0% 0%, 0% 50%; }
            100% { background-position: 0% 0%, 0% 0%, 0% 0%, 0% 0%, 0% 0%, 0% 0%, 0% 0%, 0% 0%, 300% 50%; }
        }

        @keyframes goldBarPulse {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.4); }
        }

        .sector-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .sector-icon {
            width: 50px; height: 50px;
            border: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--text-dim);
            background: var(--bg);
        }

        .sector-info h3 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 2px;
        }
        .sector-info p {
            font-size: 12px;
            color: var(--text-muted);
        }

        .sector-level {
            position: absolute;
            top: 15px; right: 15px;
        }

        .level-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .level-display {
            text-align: center;
        }

        .level-label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            color: var(--text-muted);
            display: block;
        }

        .level-value {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 24px;
            font-weight: 500;
            color: var(--text);
            display: block;
        }

        .level-arrow {
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text-dim);
            width: 24px;
            height: 24px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .level-arrow:hover {
            border-color: var(--accent);
            color: var(--text);
        }

        .sector-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg);
            border: 1px solid var(--border);
        }

        .sector-stat {
            text-align: center;
        }
        .sector-stat-label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .sector-stat-value {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 14px;
            color: var(--text);
        }

        .sector-actions {
            display: flex;
            gap: 10px;
        }

        .sector-btn {
            flex: 1;
            padding: 12px 15px;
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            text-align: center;
        }

        .sector-btn.play {
            background: var(--accent);
            color: var(--text);
        }
        .sector-btn.play:hover {
            background: var(--accent-light);
        }

        .sector-btn.upgrade {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
        }
        .sector-btn.upgrade:hover:not(:disabled) {
            border-color: var(--accent);
            color: var(--text);
        }
        .sector-btn.upgrade:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .sector-btn.upgrade.can-upgrade {
            border-color: #d4a942;
            color: #d4a942;
            position: relative;
            overflow: hidden;
            background: linear-gradient(90deg, transparent 0%, rgba(212, 169, 66, 0.1) 50%, transparent 100%);
            background-size: 200% 100%;
            animation: goldShimmer 2s ease-in-out infinite;
        }
        .sector-btn.upgrade.can-upgrade::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212, 169, 66, 0.3), transparent);
            animation: shimmerSlide 2s ease-in-out infinite;
        }
        .sector-btn.upgrade.can-upgrade:hover {
            background: rgba(212, 169, 66, 0.2);
            box-shadow: 0 0 20px rgba(212, 169, 66, 0.3);
        }

        @keyframes goldShimmer {
            0%, 100% { background-position: 200% 0; }
            50% { background-position: -200% 0; }
        }

        @keyframes shimmerSlide {
            0% { left: -100%; }
            50%, 100% { left: 100%; }
        }

        .sector-btn.upgrade.upgrading {
            pointer-events: none;
            opacity: 0.7;
        }

        .sector-card.locked {
            opacity: 0.5;
        }
        .sector-card.locked::before {
            background: var(--error);
        }
        .sector-card.locked .sector-actions {
            pointer-events: none;
        }
        .sector-card.locked .level-selector {
            visibility: hidden;
        }
        .sector-card.locked .sector-stats {
            filter: blur(2px);
        }

        .coming-soon-badge {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-panel);
            border: 1px solid var(--error);
            padding: 8px 20px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            color: var(--error);
            text-transform: uppercase;
            letter-spacing: 2px;
            z-index: 10;
        }

        .upgrade-cost {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            display: block;
            margin-top: 2px;
        }

        .data-strip {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: 30px;
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            color: var(--text-muted);
            gap: 30px;
            z-index: 100;
        }
        .data-strip span { color: var(--text-dim); }

        @keyframes upgradeFlash {
            0% { background: rgba(45, 90, 71, 0.4); }
            100% { background: transparent; }
        }
        .sector-card.upgraded {
            animation: upgradeFlash 0.5s ease-out;
        }

        /* Tablet */
        @media (max-width: 1024px) {
            .corner-data { display: none; }
            .geo-ring { display: none; }
            .main { padding: 25px 20px; }
            .sectors-grid { grid-template-columns: repeat(2, 1fr); gap: 15px; }
            .header { padding: 15px 20px; }
            .header-stats { gap: 20px; }
            .stat-value { font-size: 18px; }
            .page-title { font-size: 24px; }
        }

        /* Phone */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            .logo-group { width: 100%; justify-content: center; }
            .logo-tag { display: none; }
            .header-stats {
                width: 100%;
                justify-content: space-between;
            }
            .nav-links { gap: 5px; }
            .nav-link { padding: 6px 12px; font-size: 11px; }
            .main { padding: 20px 15px; padding-bottom: 50px; }
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                margin-bottom: 25px;
            }
            .page-meta { text-align: left; }
            .page-title { font-size: 22px; }
            .sectors-grid { grid-template-columns: 1fr; gap: 15px; }
            .sector-card { padding: 20px; }
            .sector-header { margin-bottom: 15px; }
            .sector-icon { width: 40px; height: 40px; font-size: 20px; }
            .sector-info h3 { font-size: 16px; }
            .sector-stats { gap: 8px; padding: 12px; }
            .sector-stat-value { font-size: 13px; }
            .sector-actions { flex-direction: column; gap: 8px; }
            .sector-btn { padding: 14px; min-height: 48px; }
            .level-value { font-size: 20px; }
            .level-arrow { width: 28px; height: 28px; }
            .data-strip { font-size: 9px; gap: 15px; height: 35px; }
            .coming-soon-badge { font-size: 10px; padding: 6px 15px; }
        }

        /* Small phones */
        @media (max-width: 380px) {
            .header-stats .stat { display: none; }
            .header-stats .stat:last-of-type { display: block; }
            .sector-stats { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <div class="bg-grid"></div>
    <div class="geo-ring"></div>
    <div class="geo-ring"></div>
    <div class="geo-ring"></div>

    <div class="corner-data tl">SYS.ONLINE<br>NODE <span>ALPHA-7</span><br>BUILD 3.0</div>
    <div class="corner-data tr">USR:<span>{{ current_user.username }}</span><br>ID:<span>{{ current_user.id }}</span><br>SESSION ACTIVE</div>
    <div class="corner-data bl">PROCEDURAL GEN<br>INFINITE SCALING<br>SQRT COST</div>
    <div class="corner-data br">FRAME <span>60</span><br>SYNC <span>OK</span><br>LATENCY 12ms</div>

    <header class="header">
        <div class="logo-group">
            <div class="logo">MATHLY</div>
            <div class="logo-tag">INFINITE TRAINING v3.0</div>
        </div>
        <div class="header-stats">
            <div class="stat">
                <div class="stat-label">Level</div>
                <div class="stat-value">{{ current_user.level }}</div>
            </div>
            <div class="stat">
                <div class="stat-label">Experience</div>
                <div class="stat-value" id="user-exp">{{ current_user.exp }}</div>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link">HOME</a>
                <a href="/skills" class="nav-link">SKILLS</a>
                <a href="/logout" class="nav-link">LOGOUT</a>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="page-header">
            <h1 class="page-title">Training <strong>Sectors</strong></h1>
            <div class="page-meta">
                SECTORS: {{ sectors|length }}<br>
                MODE: INFINITE
            </div>
        </div>

        <div class="sectors-grid">
            {% for sector in sectors %}
            <div class="sector-card {% if not sector.available %}locked{% endif %}" id="sector-{{ sector.key }}"
                 style="--sector-color: {{ sector.color }}"
                 data-max-level="{{ sector.level }}"
                 data-section="{{ sector.key }}">
                {% if not sector.available %}
                <div class="coming-soon-badge">Coming Soon</div>
                {% endif %}
                <div class="sector-level">
                    <div class="level-selector">
                        <button class="level-arrow left"
                                id="arrow-left-{{ sector.key }}"
                                onclick="changeLevel('{{ sector.key }}', -1)"
                                {% if sector.level <= 1 %}style="visibility: hidden;"{% endif %}>
                            <
                        </button>
                        <div class="level-display">
                            <span class="level-label">LVL</span>
                            <span class="level-value" id="selected-level-{{ sector.key }}">{{ sector.level }}</span>
                        </div>
                        <button class="level-arrow right"
                                id="arrow-right-{{ sector.key }}"
                                onclick="changeLevel('{{ sector.key }}', 1)"
                                style="visibility: hidden;">
                            >
                        </button>
                    </div>
                </div>
                <div class="sector-header">
                    <div class="sector-icon">{{ sector.icon }}</div>
                    <div class="sector-info">
                        <h3>{{ sector.name }}</h3>
                        <p id="difficulty-{{ sector.key }}">{{ sector.difficulty }}</p>
                    </div>
                </div>

                <div class="sector-stats">
                    <div class="sector-stat">
                        <div class="sector-stat-label">Range</div>
                        <div class="sector-stat-value" id="range-{{ sector.key }}">{{ sector.range }}</div>
                    </div>
                    <div class="sector-stat">
                        <div class="sector-stat-label">Per Problem</div>
                        <div class="sector-stat-value" id="exp-{{ sector.key }}">+{{ sector.exp_per_problem }} XP</div>
                    </div>
                    <div class="sector-stat">
                        <div class="sector-stat-label">Solved</div>
                        <div class="sector-stat-value">{{ sector.total_solved }}</div>
                    </div>
                    <div class="sector-stat">
                        <div class="sector-stat-label">Total EXP</div>
                        <div class="sector-stat-value">{{ sector.total_exp }}</div>
                    </div>
                </div>

                <div class="sector-actions">
                    <a href="/play/{{ sector.key }}/{{ sector.level }}"
                       class="sector-btn play"
                       id="train-btn-{{ sector.key }}">TRAIN</a>
                    <button class="sector-btn upgrade {% if sector.can_upgrade %}can-upgrade{% endif %}"
                            id="upgrade-btn-{{ sector.key }}"
                            onclick="upgradeSector('{{ sector.key }}')"
                            {% if not sector.can_upgrade %}disabled{% endif %}>
                        UPGRADE
                        <span class="upgrade-cost" id="cost-{{ sector.key }}">{{ sector.upgrade_cost }} XP</span>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </main>

    <div class="data-strip">
        <span>MATHLY.SYS</span>
        <span>|</span>
        PROCESS: ACTIVE
        <span>|</span>
        SCALING: SQRT
        <span>|</span>
        NET: STABLE
    </div>

    <script>
        let audioContext = null;

        function getAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }

        function playUpgradeSound() {
            const ctx = getAudioContext();

            const notes = [523.25, 659.25, 783.99, 1046.50];
            notes.forEach((freq, i) => {
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);

                oscillator.frequency.setValueAtTime(freq, ctx.currentTime + i * 0.08);
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0, ctx.currentTime + i * 0.08);
                gainNode.gain.linearRampToValueAtTime(0.25, ctx.currentTime + i * 0.08 + 0.02);
                gainNode.gain.linearRampToValueAtTime(0, ctx.currentTime + i * 0.08 + 0.3);

                oscillator.start(ctx.currentTime + i * 0.08);
                oscillator.stop(ctx.currentTime + i * 0.08 + 0.3);
            });
        }

        // Base green accent: #2a5d4a = HSL(155, 37%, 27%)
        // We start here and algorithmically shift hue every 5 levels

        function getTierColor(level) {
            const tier = Math.floor((level - 1) / 5);
            // Start at green hue (155) and shift by golden angle (~137.5) for good distribution
            const baseHue = 155;
            const hueShift = tier * 37; // Shift hue every 5 levels
            const hue = (baseHue + hueShift) % 360;
            // Gradually increase saturation and lightness as levels increase
            const saturation = Math.min(37 + tier * 3, 70);
            const lightness = Math.min(27 + tier * 2, 45);
            return { hue, saturation, lightness, css: `hsl(${hue}, ${saturation}%, ${lightness}%)` };
        }

        function getEffectType(level) {
            if (level >= 80) return 'gold-sparkles';
            if (level >= 60) return 'glassy';
            if (level >= 40) return 'lightning';
            if (level >= 20) return 'flames';
            return null;
        }

        function getEffectColors(level, effectType) {
            // Calculate which 5-level tier within the effect we're in
            let effectStartLevel;
            if (effectType === 'flames') effectStartLevel = 20;
            else if (effectType === 'lightning') effectStartLevel = 40;
            else if (effectType === 'glassy') effectStartLevel = 60;
            else if (effectType === 'gold-sparkles') effectStartLevel = 80;
            else return null;

            const tierWithinEffect = Math.floor((level - effectStartLevel) / 5);

            // Base palettes for each effect that shift algorithmically
            let baseHue;
            if (effectType === 'flames') {
                // Flames: Start orange-red (15), shift through warm colors
                baseHue = (15 + tierWithinEffect * 25) % 60; // Stay in warm range 0-60
            } else if (effectType === 'lightning') {
                // Lightning: Start electric blue (200), shift through cool electric colors
                baseHue = 180 + ((tierWithinEffect * 30) % 80); // Range 180-260
            } else if (effectType === 'glassy') {
                // Glassy: Full spectrum, shifting through all colors
                baseHue = (tierWithinEffect * 45) % 360;
            } else if (effectType === 'gold-sparkles') {
                // Gold sparkles: Start gold (45), shift through precious metal colors
                baseHue = (45 + tierWithinEffect * 20) % 360;
            }

            // Generate 4 colors based on the base hue
            const colors = [];
            for (let i = 0; i < 4; i++) {
                const hue = (baseHue + i * 15) % 360;
                let sat, light;
                if (effectType === 'flames') {
                    sat = 100;
                    light = 50 + i * 8;
                } else if (effectType === 'lightning') {
                    sat = 80 + i * 5;
                    light = 55 + i * 10;
                } else if (effectType === 'glassy') {
                    sat = 40 + i * 10;
                    light = 70 + i * 5;
                } else if (effectType === 'gold-sparkles') {
                    sat = 85 - i * 5;
                    light = 50 + i * 10;
                }
                colors.push(`hsl(${hue}, ${sat}%, ${light}%)`);
            }
            return colors;
        }

        function hslToRgb(h, s, l) {
            s /= 100;
            l /= 100;
            const a = s * Math.min(l, 1 - l);
            const f = n => {
                const k = (n + h / 30) % 12;
                return l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
            };
            return [Math.round(f(0) * 255), Math.round(f(8) * 255), Math.round(f(4) * 255)];
        }

        function applyTierStyle(section, level) {
            const card = document.getElementById(`sector-${section}`);
            if (!card || card.classList.contains('locked')) return;

            // Apply tier color (border color that changes every 5 levels)
            const tierColor = getTierColor(level);
            card.style.setProperty('--tier-color', tierColor.css);

            // Determine if we have a special effect
            const effectType = getEffectType(level);

            if (effectType) {
                const effectColors = getEffectColors(level, effectType);
                card.setAttribute('data-effect', effectType);

                // Set effect colors as CSS variables
                if (effectColors) {
                    card.style.setProperty('--effect-color-1', effectColors[0]);
                    card.style.setProperty('--effect-color-2', effectColors[1]);
                    card.style.setProperty('--effect-color-3', effectColors[2]);
                    card.style.setProperty('--effect-color-4', effectColors[3]);
                }

                // For glassy effect, set RGB values for rgba() usage
                if (effectType === 'glassy') {
                    const tierWithinGlassy = Math.floor((level - 60) / 5);
                    const glassHue = (tierWithinGlassy * 45) % 360;
                    const rgb = hslToRgb(glassHue, 50, 70);
                    card.style.setProperty('--glass-r', rgb[0]);
                    card.style.setProperty('--glass-g', rgb[1]);
                    card.style.setProperty('--glass-b', rgb[2]);
                }
            } else {
                card.removeAttribute('data-effect');
            }
        }

        const sectorData = {};
        document.querySelectorAll('.sector-card').forEach(card => {
            const section = card.dataset.section;
            const level = parseInt(card.dataset.maxLevel);
            sectorData[section] = {
                maxLevel: level,
                selectedLevel: level
            };
            applyTierStyle(section, level);
        });

        function changeLevel(section, delta) {
            const data = sectorData[section];
            const newLevel = data.selectedLevel + delta;

            if (newLevel < 1 || newLevel > data.maxLevel) return;

            data.selectedLevel = newLevel;

            document.getElementById(`selected-level-${section}`).textContent = newLevel;
            document.getElementById(`train-btn-${section}`).href = `/play/${section}/${newLevel}`;

            const leftArrow = document.getElementById(`arrow-left-${section}`);
            const rightArrow = document.getElementById(`arrow-right-${section}`);

            leftArrow.style.visibility = newLevel <= 1 ? 'hidden' : 'visible';
            rightArrow.style.visibility = newLevel >= data.maxLevel ? 'hidden' : 'visible';
        }

        function setButtonContent(btn, text, cost) {
            btn.innerHTML = `${text}<span class="upgrade-cost" id="cost-${btn.id.replace('upgrade-btn-', '')}">${cost} XP</span>`;
        }

        async function upgradeSector(section) {
            const btn = document.getElementById(`upgrade-btn-${section}`);
            const currentCost = document.getElementById(`cost-${section}`).textContent;

            btn.disabled = true;
            btn.classList.add('upgrading');
            setButtonContent(btn, 'UPGRADING...', currentCost.replace(' XP', ''));

            try {
                const res = await fetch(`/upgrade/${section}`, { method: 'POST' });
                const data = await res.json();

                if (data.success) {
                    playUpgradeSound();

                    document.getElementById('user-exp').textContent = data.remaining_exp;
                    document.getElementById(`selected-level-${section}`).textContent = data.new_level;
                    document.getElementById(`difficulty-${section}`).textContent = data.difficulty;
                    document.getElementById(`range-${section}`).textContent = data.range;
                    document.getElementById(`exp-${section}`).textContent = `+${data.exp_per_problem} XP`;

                    sectorData[section].maxLevel = data.new_level;
                    sectorData[section].selectedLevel = data.new_level;
                    document.getElementById(`train-btn-${section}`).href = `/play/${section}/${data.new_level}`;

                    const leftArrow = document.getElementById(`arrow-left-${section}`);
                    leftArrow.style.visibility = data.new_level > 1 ? 'visible' : 'hidden';
                    document.getElementById(`arrow-right-${section}`).style.visibility = 'hidden';

                    const card = document.getElementById(`sector-${section}`);
                    card.dataset.maxLevel = data.new_level;
                    card.classList.add('upgraded');
                    setTimeout(() => card.classList.remove('upgraded'), 500);

                    applyTierStyle(section, data.new_level);

                    btn.classList.remove('upgrading');
                    setButtonContent(btn, 'UPGRADE', data.next_upgrade_cost);

                    if (data.can_upgrade) {
                        btn.disabled = false;
                        btn.classList.add('can-upgrade');
                    } else {
                        btn.disabled = true;
                        btn.classList.remove('can-upgrade');
                    }

                    updateAllUpgradeButtons(data.remaining_exp);
                } else {
                    btn.classList.remove('upgrading');
                    setButtonContent(btn, 'UPGRADE', currentCost.replace(' XP', ''));
                    btn.disabled = false;
                    alert(data.error || 'Upgrade failed');
                }
            } catch (err) {
                btn.classList.remove('upgrading');
                setButtonContent(btn, 'UPGRADE', currentCost.replace(' XP', ''));
                btn.disabled = false;
                console.error(err);
            }
        }

        function updateAllUpgradeButtons(userExp) {
            document.querySelectorAll('.sector-btn.upgrade').forEach(btn => {
                const costEl = btn.querySelector('.upgrade-cost');
                if (costEl) {
                    const cost = parseInt(costEl.textContent);
                    if (userExp >= cost) {
                        btn.disabled = false;
                        btn.classList.add('can-upgrade');
                    } else {
                        btn.disabled = true;
                        btn.classList.remove('can-upgrade');
                    }
                }
            });
        }
    </script>
</body>
</html>
